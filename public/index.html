<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bandwidth Hero - Command Center</title>
    <style>
        :root { 
            --bg: #050505; 
            --panel: #111111; 
            --border: #333; 
            --primary: #00ff9d; /* Cyber Green */
            --secondary: #00b8ff; /* Cyber Blue */
            --danger: #ff3860;
            --text: #e0e0e0; 
            --mono: 'Courier New', Courier, monospace;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }

        /* HEADER ESTILO HUD */
        header { background: var(--panel); border-bottom: 1px solid var(--border); padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
        .brand h1 { margin: 0; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; background: linear-gradient(90deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .brand span { font-size: 0.8rem; color: #666; letter-spacing: 1px; }
        .system-status { display: flex; gap: 1rem; font-size: 0.8rem; font-family: var(--mono); }
        .status-dot { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; display: inline-block; box-shadow: 0 0 10px var(--primary); animation: blink 2s infinite; }

        /* MAIN LAYOUT */
        main { flex: 1; padding: 2rem; max-width: 1400px; margin: 0 auto; width: 100%; display: grid; grid-template-columns: 350px 1fr; gap: 2rem; }
        
        /* PANELES LATERALES */
        aside { display: flex; flex-direction: column; gap: 1.5rem; }
        
        .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .panel-head { background: #1a1a1a; padding: 0.8rem; border-bottom: 1px solid var(--border); font-size: 0.9rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; }
        .panel-body { padding: 1.5rem; }

        /* FORMULARIO */
        .input-group { position: relative; margin-bottom: 1rem; }
        input[type="url"] { width: 100%; background: #000; border: 1px solid var(--border); padding: 1rem; color: var(--primary); font-family: var(--mono); border-radius: 4px; outline: none; transition: 0.3s; }
        input[type="url"]:focus { border-color: var(--primary); box-shadow: 0 0 10px rgba(0, 255, 157, 0.1); }
        button.btn-main { width: 100%; background: var(--primary); color: #000; border: none; padding: 1rem; font-weight: bold; text-transform: uppercase; cursor: pointer; border-radius: 4px; transition: 0.2s; letter-spacing: 1px; }
        button.btn-main:hover { background: #fff; box-shadow: 0 0 15px var(--primary); }

        /* TERMINAL LOG */
        #terminal { background: #000; font-family: var(--mono); font-size: 0.85rem; height: 250px; overflow-y: auto; padding: 1rem; color: #aaa; border-top: 1px solid var(--border); }
        .log-line { margin-bottom: 0.5rem; display: block; opacity: 0; animation: fadeIn 0.2s forwards; }
        .log-time { color: #555; margin-right: 0.5rem; }
        .log-info { color: var(--secondary); }
        .log-success { color: var(--primary); }
        .log-warn { color: var(--danger); }

        /* VISOR DE IMAGEN (COMPARADOR) */
        .viewer-container { display: flex; flex-direction: column; height: 100%; gap: 1rem; }
        
        /* SLIDER COMPARATIVO CSS */
        .comparison-slider { position: relative; width: 100%; max-width: 800px; height: 500px; margin: 0 auto; overflow: hidden; border-radius: 8px; border: 1px solid var(--border); background: #000; display: none; }
        .comparison-slider img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
        .modified-image { clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%); }
        .slider-handle { position: absolute; top: 0; bottom: 0; left: 50%; width: 2px; background: var(--primary); cursor: ew-resize; z-index: 10; box-shadow: 0 0 10px var(--primary); }
        .slider-handle::after { content: '< >'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--primary); color: #000; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; white-space: nowrap; }
        .label { position: absolute; bottom: 10px; padding: 5px 10px; background: rgba(0,0,0,0.7); border-radius: 4px; font-size: 12px; font-weight: bold; pointer-events: none; }
        .label-before { right: 10px; color: #fff; border: 1px solid #555; }
        .label-after { left: 10px; color: var(--primary); border: 1px solid var(--primary); }

        /* METRICAS */
        .metrics-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem; }
        .metric-card { background: var(--panel); border: 1px solid var(--border); padding: 1rem; border-radius: 8px; text-align: center; }
        .metric-val { font-size: 1.8rem; font-weight: bold; color: var(--text); display: block; }
        .metric-label { font-size: 0.7rem; text-transform: uppercase; color: #666; letter-spacing: 1px; }
        .saving-bar-container { height: 6px; background: #333; border-radius: 3px; margin-top: 10px; overflow: hidden; }
        .saving-bar { height: 100%; background: var(--primary); width: 0%; transition: width 1s ease; }

        /* API LINK */
        .api-box { background: #000; padding: 10px; font-family: var(--mono); border: 1px dashed #444; color: #888; font-size: 0.8rem; word-break: break-all; cursor: pointer; }
        .api-box:hover { color: var(--primary); border-color: var(--primary); }

        /* ANIMACIONES */
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        @keyframes fadeIn { to { opacity: 1; } }

        @media (max-width: 900px) {
            main { grid-template-columns: 1fr; }
            .comparison-slider { height: 300px; }
        }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <h1>BANDWIDTH HERO</h1>
        <span>HYBRID PROCESSING UNIT v7.0</span>
    </div>
    <div class="system-status">
        <span>PHOTON: <strong style="color:var(--primary)">ONLINE</strong></span>
        <span>VERCEL: <strong style="color:var(--primary)">READY</strong></span>
        <span class="status-dot"></span>
    </div>
</header>

<main>
    <!-- BARRA LATERAL: CONTROLES Y LOGS -->
    <aside>
        <div class="panel">
            <div class="panel-head">
                <span>Control de Misi√≥n</span>
                <span>üì°</span>
            </div>
            <div class="panel-body">
                <form id="compress-form">
                    <div class="input-group">
                        <label style="font-size: 0.8rem; color: #888; display: block; margin-bottom: 5px;">URL de Origen (Manga/Manhua)</label>
                        <input type="url" id="url-input" placeholder="https://..." required autocomplete="off">
                    </div>
                    <button type="submit" class="btn-main" id="btn-action">INICIAR SECUENCIA</button>
                </form>
                <div style="margin-top: 1.5rem;">
                    <label style="font-size: 0.8rem; color: #888;">Enlace para Tachiyomi:</label>
                    <div class="api-box" id="api-url" onclick="copyToClipboard()">
                        Cargando endpoint...
                    </div>
                </div>
            </div>
        </div>

        <div class="panel" style="flex: 1; display: flex; flex-direction: column;">
            <div class="panel-head">
                <span>Terminal del Sistema</span>
                <span style="font-size: 0.7rem; opacity: 0.5;">LIVE LOGS</span>
            </div>
            <div id="terminal">
                <span class="log-line"><span class="log-time">--:--:--</span> System initialized. Waiting for input...</span>
            </div>
        </div>
    </aside>

    <!-- AREA PRINCIPAL: VISUALIZACI√ìN -->
    <div class="viewer-container">
        <!-- M√âTRICAS SUPERIORES -->
        <div class="metrics-grid">
            <div class="metric-card">
                <span class="metric-val" id="val-latency">0ms</span>
                <span class="metric-label">Latencia Total</span>
            </div>
            <div class="metric-card">
                <span class="metric-val" id="val-orig">0 KB</span>
                <span class="metric-label">Peso Entrada (Photon)</span>
            </div>
            <div class="metric-card">
                <span class="metric-val" id="val-final" style="color: var(--primary)">0 KB</span>
                <span class="metric-label">Peso Salida</span>
            </div>
            <div class="metric-card">
                <span class="metric-val" id="val-save">0%</span>
                <span class="metric-label">Eficiencia</span>
                <div class="saving-bar-container"><div class="saving-bar" id="bar-save"></div></div>
            </div>
        </div>

        <!-- SLIDER VISUAL -->
        <div class="panel" style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #080808; padding: 0;">
            <div id="placeholder-msg" style="color: #444; text-align: center;">
                <h2>ESPERANDO DATOS</h2>
                <p>Introduce una URL para analizar la compresi√≥n h√≠brida.</p>
            </div>
            
            <div class="comparison-slider" id="slider-container">
                <img id="img-before" src="" alt="Before">
                <img id="img-after" src="" alt="After" class="modified-image">
                <div class="slider-handle"></div>
                <span class="label label-after">OPTIMIZADA (Vercel/Photon)</span>
                <span class="label label-before">ORIGEN (Simulado)</span>
            </div>
        </div>
    </div>
</main>

<script>
    // --- CONFIGURACI√ìN ---
    const API_ROOT = window.location.origin + '/api/compress';
    document.getElementById('api-url').textContent = API_ROOT + '?url=';

    // --- UTILIDADES TERMINAL ---
    const terminal = document.getElementById('terminal');
    function log(msg, type = 'info') {
        const now = new Date().toLocaleTimeString();
        const line = document.createElement('div');
        line.className = 'log-line';
        
        let colorClass = 'log-info';
        if (type === 'success') colorClass = 'log-success';
        if (type === 'warn') colorClass = 'log-warn';

        line.innerHTML = `<span class="log-time">[${now}]</span> <span class="${colorClass}">${msg}</span>`;
        terminal.appendChild(line);
        terminal.scrollTop = terminal.scrollHeight;
    }

    // --- L√ìGICA PRINCIPAL ---
    document.getElementById('compress-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const url = document.getElementById('url-input').value;
        const btn = document.getElementById('btn-action');
        
        // Reset UI
        btn.disabled = true;
        btn.textContent = "PROCESANDO...";
        document.getElementById('placeholder-msg').style.display = 'none';
        document.getElementById('slider-container').style.display = 'none';
        terminal.innerHTML = '';
        
        // Simulaci√≥n de proceso en Terminal
        log("Iniciando secuencia de optimizaci√≥n...", "info");
        log(`Objetivo: ${url.substring(0, 30)}...`, "info");
        
        const startTime = Date.now();

        try {
            log("Contactando Photon CDN para pre-procesamiento...", "warn");
            
            const apiUrl = `${API_ROOT}?url=${encodeURIComponent(url)}`;
            const response = await fetch(apiUrl);
            
            const latency = Date.now() - startTime;
            log(`Respuesta recibida en ${latency}ms`, "success");

            if (!response.ok) throw new Error(`Error HTTP ${response.status}`);

            // Extracci√≥n de Headers (La historia del proceso)
            const processor = response.headers.get('X-Processor') || 'Unknown';
            const compSize = parseInt(response.headers.get('X-Compressed-Size') || 0);
            const contentType = response.headers.get('Content-Type');
            
            // Simulamos el peso original bas√°ndonos en si fue comprimido o no
            // (Como Photon no nos da el peso original real, estimamos para la demo)
            let origSizeEst = compSize; 
            if (processor.includes('Vercel')) {
                origSizeEst = Math.round(compSize * 3.5); // Estimaci√≥n: AVIF suele ser 3-4 veces menor
                log("‚ö†Ô∏è ALERTA: Peso excedi√≥ 100KB en Photon.", "warn");
                log("‚öôÔ∏è Vercel Engine ACTIVADO: Compresi√≥n AVIF Q25.", "warn");
            } else {
                log("‚úÖ PESO SEGURO: < 100KB detectado.", "success");
                log("üí® Modo Passthrough: Retransmisi√≥n directa.", "success");
            }

            log(`Procesador Final: ${processor}`, "info");
            log(`Formato de Salida: ${contentType.toUpperCase()}`, "info");

            // Convertir a Blob para visualizar
            const blob = await response.blob();
            const imgUrl = URL.createObjectURL(blob);

            // Actualizar Dashboard
            updateMetrics(latency, origSizeEst, compSize);
            setupSlider(url, imgUrl);

            btn.disabled = false;
            btn.textContent = "INICIAR SECUENCIA";

        } catch (error) {
            log(`FATAL ERROR: ${error.message}`, "warn");
            btn.disabled = false;
            btn.textContent = "REINTENTAR";
        }
    });

    // --- M√âTRICAS VISUALES ---
    function updateMetrics(latency, orig, comp) {
        document.getElementById('val-latency').textContent = latency + 'ms';
        document.getElementById('val-orig').textContent = formatBytes(orig);
        document.getElementById('val-final').textContent = formatBytes(comp);
        
        const saving = orig > 0 ? Math.round(((orig - comp) / orig) * 100) : 0;
        const finalSaving = saving < 0 ? 0 : saving; // Evitar negativos si Photon ya estaba optimizado
        
        document.getElementById('val-save').textContent = finalSaving + '%';
        document.getElementById('bar-save').style.width = finalSaving + '%';
    }

    function formatBytes(bytes) {
        if (!+bytes) return '0 B';
        const sizes = ['B', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return `${parseFloat((bytes / Math.pow(1024, i)).toFixed(1))} ${sizes[i]}`;
    }

    // --- SLIDER INTERACTIVO ---
    function setupSlider(originalUrl, newUrl) {
        const slider = document.getElementById('slider-container');
        const imgBefore = document.getElementById('img-before');
        const imgAfter = document.getElementById('img-after');
        const handle = document.querySelector('.slider-handle');
        
        slider.style.display = 'block';
        imgBefore.src = originalUrl; // URL Original
        imgAfter.src = newUrl;       // URL Blob Optimizado

        let isDragging = false;

        function move(e) {
            if (!isDragging) return;
            const rect = slider.getBoundingClientRect();
            let x = (e.clientX || e.touches[0].clientX) - rect.left;
            x = Math.max(0, Math.min(x, rect.width));
            const percent = (x / rect.width) * 100;
            
            handle.style.left = percent + '%';
            imgAfter.style.clipPath = `polygon(0 0, ${percent}% 0, ${percent}% 100%, 0 100%)`;
        }

        slider.addEventListener('mousedown', () => isDragging = true);
        slider.addEventListener('touchstart', () => isDragging = true);
        window.addEventListener('mouseup', () => isDragging = false);
        window.addEventListener('touchend', () => isDragging = false);
        window.addEventListener('mousemove', move);
        window.addEventListener('touchmove', move);
    }

    function copyToClipboard() {
        const text = document.getElementById('api-url').textContent;
        navigator.clipboard.writeText(text);
        log("Endpoint copiado al portapapeles", "success");
    }
</script>
</body>
</html>
